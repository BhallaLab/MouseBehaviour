<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Run pipeline - MouseBehaviour</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
  <link href="../extra.css" rel="stylesheet">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Run pipeline";
    var mkdocs_page_input_path = "run_pipeline.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/yaml.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/c++.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/python.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> MouseBehaviour</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="..">Home</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../build_pipeline/">Build pipeline</a>
	    </li>
          
            <li class="toctree-l1 current">
		
    <a class="current" href="./">Run pipeline</a>
    <ul class="subnav">
            
    <li class="toctree-l2"><a href="#docker">Docker</a></li>
    

    <li class="toctree-l2"><a href="#ubuntu-1604">Ubuntu 16.04</a></li>
    

    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../gui/">Using GUI</a>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">MouseBehaviour</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
    
    <li>Run pipeline</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/BhallaLab/MouseBehaviour/edit/master/docs/run_pipeline.md"
          class="icon icon-github"> Edit on GitHub</a>
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <p><img alt="Docker Pulls" src="https://img.shields.io/docker/pulls/bhallalab/mousebehaviour.svg" /></p>
<p>Docker is the recommended for running this pipeline. All dependencies, user
permissions, and other setups are backed into this image. See the section
<a href="#ubuntu-1604">Ubuntu 16-04</a> for running this pipeline without docker.</p>
<h1 id="docker">Docker</h1>
<div class="admonition note">
<p class="admonition-title">Installing Docker</p>
<ol>
<li>You should be in <code>sudo</code> group e.g., you should be able to install
   softwares. Try this,
   <pre class="highlight"><code class="language-bash">$ sudo apt upadate</code></pre>
   If this is successful then you are good to go.</li>
<li>
<p>You must be in <code>docker</code> group. Type <code>groups</code> in terminal. If <code>docker</code>
   appears in the output then you are already in docker group.</p>
</li>
<li>
<p>Follow <a href="https://docs.docker.com/install">these instruction to install docker</a>.
   Also see <a href="https://docs.docker.com/config/daemon/systemd/#httphttps-proxy">these
   instructions</a>
   for adding proxy support to docker. To check that docker works fine, execute
   following in the terminal.</p>
</li>
</ol>
<pre class="highlight"><code class="language-bash">$ docker run hello-world</code></pre>

<p>I saw the following output.</p>
<pre class="highlight"><code class="language-bash">Unable to find image 'hello-world:latest' locally
latest: Pulling from library/hello-world
1b930d010525: Pull complete 
Digest: sha256:6540fc08ee6e6b7b63468dc3317e3303aae178cb8a45ed3123180328bcc1d20f
Status: Downloaded newer image for hello-world:latest

Hello from Docker!
. 
.</code></pre>

</div>
<p>The docker image is available at
<a href="https://hub.docker.com/r/bhallalab/mousebehavioum">https://hub.docker.com/r/bhallalab/mousebehavioum</a>. You can get it by executing
the following:</p>
<pre class="highlight"><code class="language-bash">$ docker pull bhallalab/mousebehaviour</code></pre>

<p>This image is over 1.3GB! It is going to take a while to download.</p>
<p>Now we are ready to run the pipeline. But before we run this image, we must make
sure that docker can access devices connected to host computer. We also need to
collect data generated inside the docker during experiment and save it to the
host machine.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Type <code>xhost +</code> once in the terminal. This makes docker to access
graphics. You have to do it just once.</p>
</div>
<p>The camera and Arduino Uno board must be connected to host computer if you are
using this image for running behaviour session. They are not required for
analysis. </p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>For getting decent frames per second, camera needs to be connected to a
<code>USB3.0</code> port. I was able to get 200 FPS.</p>
</div>
<details class="note"><summary>How to find out USB-3.0 port</summary><p>Ref: <a href="https://unix.stackexchange.com/a/112152/5362">https://unix.stackexchange.com/a/112152/5362</a></p>
<ol>
<li>It has blue color.</li>
<li>Use <code>lsusb</code> command to check if you computer has it
   <pre class="highlight"><code class="language-bash">$ sudo lsusb -v | grep -iE "Bus|^Device Desc|bcdusb"</code></pre>
   On my system, I get the following output. You can see the a device by <code>Point Grey
   Research, Inc.</code> connected to USB3.0 (<code>bcdUSB 3.00</code>).</li>
</ol>
<pre class="highlight"><code class="language-bash"> Bus 002 Device 003: ID 1e10:4000 Point Grey Research, Inc. 
 Device Descriptor:
   bcdUSB               3.00
       (Bus Powered)
   (Bus Powered)
 Bus 002 Device 001: ID 1d6b:0003 Linux Foundation 3.0 root hub
 Device Descriptor:
   bcdUSB               3.00
 Bus 001 Device 006: ID 1a86:7523 QinHeng Electronics HL-340 USB-Serial adapter
 Device Descriptor:
   bcdUSB               1.10
       (Bus Powered)
   (Bus Powered)
 Bus 001 Device 002: ID 0bda:5686 Realtek Semiconductor Corp. 
 Device Descriptor:
   bcdUSB               2.00
       (Bus Powered)
   bcdUSB               2.00
   (Bus Powered)
 Bus 001 Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub
 Device Descriptor:
   bcdUSB               2.00</code></pre>

</details>
<pre class="highlight"><code class="language-bash">docker run --rm \
    --net=host --privileged \
    -v /dev:/dev \
    -e DISPLAY=$(DISPLAY) \
    -v /tmp/.X11-unix:/tmp/.X11-unix \
    -v $(HOME)/.Xauthority:/root/.Xauthority \
    -v $(HOME)/DATA:/root/DATA \
    -it bhallalab/mousebehaviour</code></pre>

<p>And voila, you should see this gui. More information is here <a href="gui">GUI</a>. When in
doubt, hover your mouse pointer on gui and a helpful message should pop-up
(hopefully).</p>
<p><img alt="" src="../images/gui_in_docker.png" /></p>
<h1 id="ubuntu-1604">Ubuntu 16.04</h1>
<p>If you can't use docker, you can build and run the pipeline in Ubuntu-16.04
based system. The camera firmware version which we have used is compatible with
Ubuntu-16.04. The vendor also supports Ubuntu-18.04 but we have not ported our
code to this Ubuntu-18.04 yet.</p>
<ol>
<li>Create an admin account, say <code>chuha</code> (Hindi for mouse). Login.</li>
<li>
<p>Add <code>chuha</code> to following groups: </p>
<ul>
<li><code>dialout</code> To access arduino.</li>
<li><code>pgrimaging</code> To access PointGrey camera (Also see <code>udev</code> related note).
Following script should do the job.</li>
</ul>
<pre class="highlight"><code class="language-bash">$ sudo groupadd -f dialout
$ sudo groupadd -f pgrimaging
$ sudo usermod -a -G dialout,pgrimaging chuha</code></pre>

<p><mark>Logout and login again.</mark> Changes to group takes effect on a fresh login.</p>
</li>
<li>
<p>(<strong>udev</strong>) Add <code>udev</code> rules. We need them for accessing camera events.</p>
<pre class="highlight"><code class="language-bash">$ mkdir -p /etc/udev/rules.d 
$ echo "SUBSYSTEM==\"usb\", GROUP=\"pgrimaging\"" &gt;/etc/udev/rules.d/40-pgr.rules
$ /etc/init.d/udev restart</code></pre>

</li>
<li>
<p>Install python3.6. The GUI and analysis scripts requires python3.6 or higher.
   It is not available in official repositories, so we need to use a ppa.
    <pre class="highlight"><code class="language-bash">$ sudo add-apt-repository ppa:deadsnakes/ppa
$ sudo apt-get update
$ sudo apt-get install python3.6-tk python3.6-venv python3.6-dev</code></pre></p>
</li>
<li>
<p>Install required packages using <code>apt</code>.
    <pre class="highlight"><code class="language-bash">$ sudo apt-get install -y cmake g++ git
$ sudo apt-get install -y libboost-all-dev libopencv-dev libserial-dev arduino-core</code></pre></p>
</li>
<li>
<p>Create <code>python3.6</code> virtualenv and enable it.
    <pre class="highlight"><code class="language-bash">$ python3.6 -m venv ~/PY36
$ source ~/PY36/bin/activate </code></pre>
   To make sure that python3.6 becomes default python, add <code>source
   ~/PY36/bin/activate</code> to your <code>~/.bashrc</code> or <code>~/.profile</code> file. For more, see
   the official documentations <a href="https://docs.python.org/3.6/tutorial/venv.html">https://docs.python.org/3.6/tutorial/venv.html</a></p>
</li>
<li>
<p>Install required python packages.
    <pre class="highlight"><code class="language-bash">$ pip install -r  matplotlib scipy tables screeninfo numpy pandas pyserial pysimplegui pillow</code></pre></p>
</li>
</ol>
<div class="admonition note">
<p class="admonition-title">One script to do this all</p>
<p>This all is collected in one scripts <code>./scripts/bootstrap.sh</code>. Use it at your
own risk.</p>
</div>
<p>And we are done. Lets launch the gui <code>$ python gui.py</code>.</p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../gui/" class="btn btn-neutral float-right" title="Using GUI">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../build_pipeline/" class="btn btn-neutral" title="Build pipeline"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
          <a href="https://github.com/BhallaLab/MouseBehaviour/" class="fa fa-github" style="float: left; color: #fcfcfc"> GitHub</a>
      
      
        <span><a href="../build_pipeline/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../gui/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js" defer></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" defer></script>
      <script src="../search/main.js" defer></script>

</body>
</html>
