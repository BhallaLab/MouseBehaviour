<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Run pipeline - MouseBehaviour</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
  <link href="../extra.css" rel="stylesheet">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Run pipeline";
    var mkdocs_page_input_path = "run_pipeline.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/yaml.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/c++.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/python.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> MouseBehaviour</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="..">Home</a>
	    </li>
          
            <li class="toctree-l1 current">
		
    <a class="current" href="./">Run pipeline</a>
    <ul class="subnav">
            
    <li class="toctree-l2"><a href="#docker">Docker</a></li>
    

    <li class="toctree-l2"><a href="#ubuntu-1604">Ubuntu 16.04</a></li>
    

    <li class="toctree-l2"><a href="#gui">GUI</a></li>
    

    <li class="toctree-l2"><a href="#protocols">Protocols</a></li>
    
        <ul>
        
            <li><a class="toctree-l3" href="#send-commands-to-arduino">Send commands to arduino</a></li>
        
            <li><a class="toctree-l3" href="#what-is-being-printed">What is being printed?</a></li>
        
        </ul>
    

    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../build_pipeline/">Build pipeline</a>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">MouseBehaviour</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
    
    <li>Run pipeline</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/BhallaLab/MouseBehaviour/edit/master/docs/run_pipeline.md"
          class="icon icon-github"> Edit on GitHub</a>
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <p>Docker is the recommended to run this pipeline. To get the required image,
execute <code>docker pull bhallalab/mousebehaviour</code> in the terminal.</p>
<details class="note"><summary>Installing Docker</summary><p><strong>Installing and checking docker</strong></p>
<p>Follow <a href="https://docs.docker.com/install">these instruction to install docker</a>.
Also see <a href="https://docs.docker.com/config/daemon/systemd/#httphttps-proxy">these
instructions</a>
for adding proxy support to docker. To check that docker works fine, execute
following in the terminal.</p>
<pre class="highlight"><code class="language-bash">$ docker run hello-world</code></pre>

<p>I saw the following output.</p>
<pre class="highlight"><code>Unable to find image 'hello-world:latest' locally
latest: Pulling from library/hello-world
1b930d010525: Pull complete 
Digest: sha256:6540fc08ee6e6b7b63468dc3317e3303aae178cb8a45ed3123180328bcc1d20f
Status: Downloaded newer image for hello-world:latest

Hello from Docker!
. 
.</code></pre>

</details>
<h1 id="docker">Docker</h1>
<p>The docker image is available at
<a href="https://hub.docker.com/r/bhallalab/mousebehavioum">https://hub.docker.com/r/bhallalab/mousebehavioum</a>. You can get it by executing
the following:</p>
<pre class="highlight"><code class="language-bash">$ docker pull bhallalab/mousebehaviour</code></pre>

<p>Before we run this image, we must make sure that docker can access
devices connected to host computer. We also need to collect data 
generated inside the docker during experiment and save it to the host machine.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Type <code>xhost +</code> once in the terminal. This makes docker to access
graphics. You have to do it just once.</p>
</div>
<p>Following command inside the terminal did the job for me. </p>
<p>Make sure that camera and Arduino Uno board are connected to host computer.
Camera requires <code>USB3.0</code> if you want high frame rate. We were able to get 200
FPS.</p>
<pre class="highlight"><code class="language-bash"># camera and arduino must be connected.
docker run --rm \
    --net=host --privileged \
    -v /dev:/dev \
    -e DISPLAY=$(DISPLAY) \
    -v /tmp/.X11-unix:/tmp/.X11-unix \
    -v $(HOME)/.Xauthority:/root/.Xauthority \
    -v $(HOME)/DATA:/root/DATA \
    -it bhallalab/mousebehaviour</code></pre>

<p>And voila, you should see this gui. More information is <a href="gui.md">here</a>. When in
doubt, hover your mouse pointer on gui and a helpful message should pop-up
(hopefully).</p>
<p><img alt="" src="../images/gui_in_docker.png" /></p>
<h1 id="ubuntu-1604">Ubuntu 16.04</h1>
<p>If you can't use docker, you can build and run the pipeline in Ubuntu-16.04
based system. The camera firmware version which we have used is compatible with
Ubuntu-16.04. The vendor also supports Ubuntu-18.04 but we have not ported our
code to this Ubuntu-18.04 yet.</p>
<ol>
<li>Create an admin account, say <code>chuha</code> (Hindi for mouse). Login.</li>
<li>
<p>Add <code>chuha</code> to following groups: </p>
<ul>
<li><code>dialout</code> To access arduino.</li>
<li><code>pgrimaging</code> To access PointGrey camera (Also see <code>udev</code> related note).
Following script should do the job.</li>
</ul>
<pre class="highlight"><code class="language-bash">$ sudo groupadd -f dialout
$ sudo groupadd -f pgrimaging
$ sudo usermod -a -G dialout,pgrimaging chuha</code></pre>

<p><mark>Logout and login again.</mark> Changes to group takes effect on a fresh login.</p>
</li>
<li>
<p>(<strong>udev</strong>) Add <code>udev</code> rules. We need them for accessing camera events.</p>
<pre class="highlight"><code class="language-bash">$ mkdir -p /etc/udev/rules.d 
$ echo "SUBSYSTEM==\"usb\", GROUP=\"pgrimaging\"" &gt;/etc/udev/rules.d/40-pgr.rules
$ /etc/init.d/udev restart</code></pre>

</li>
<li>
<p>Install python3.6. The GUI and analysis scripts requires python3.6 or higher.
   It is not available in official repositories, so we need to use a ppa.
    <pre class="highlight"><code class="language-bash">$ sudo add-apt-repository ppa:deadsnakes/ppa
$ sudo apt-get update
$ sudo apt-get install python3.6-tk python3.6-venv python3.6-dev</code></pre></p>
</li>
<li>
<p>Install required packages using <code>apt</code>.
    <pre class="highlight"><code class="language-bash">$ sudo apt-get install -y cmake g++ git
$ sudo apt-get install -y libboost-all-dev libopencv-dev libserial-dev arduino-core</code></pre></p>
</li>
<li>
<p>Create <code>python3.6</code> virtualenv and enable it.
    <pre class="highlight"><code class="language-bash">$ python3.6 -m venv ~/PY36
$ source ~/PY36/bin/activate </code></pre>
   To make sure that python3.6 becomes default python, add <code>source
   ~/PY36/bin/activate</code> to your <code>~/.bashrc</code> or <code>~/.profile</code> file. For more, see
   the official documentations <a href="https://docs.python.org/3.6/tutorial/venv.html">https://docs.python.org/3.6/tutorial/venv.html</a></p>
</li>
<li>
<p>Install required python packages.
    <pre class="highlight"><code class="language-bash">$ pip install -r  matplotlib scipy tables screeninfo numpy pandas pyserial pysimplegui pillow</code></pre></p>
</li>
</ol>
<div class="admonition note">
<p class="admonition-title">One script to do this all</p>
<p>This all is collected in one scripts <code>./scripts/bootstrap.sh</code>. Use it at your
own risk.</p>
</div>
<p>And we are done. Lets launch the gui <code>$ python gui.py</code>.</p>
<h1 id="gui">GUI</h1>
<p>GUI has two tabs. First is to analyse the <code>tiff</code> files generated during the
session and, second one to run the session.</p>
<h1 id="protocols">Protocols</h1>
<p>A protocol must be listed in <code>./Protocols/BehaviourProtocols.csv</code>. You must
specify the right protocol code during configuration. </p>
<h2 id="send-commands-to-arduino">Send commands to arduino</h2>
<p>To send commands to arduino, make sure that you focus on the window which shows
camera frames (click on it). </p>
<p>Press the following character to issue corresponding command.</p>
<ul>
<li><code>p</code> <strong>Puff</strong> </li>
<li><code>t</code> <strong>Tone</strong></li>
<li><code>l</code> <strong>Led</strong> </li>
<li><code>c</code> <strong>Shock</strong> </li>
<li><code>s</code> <strong>Start the session</strong>. After pressing <code>s</code>, arduino will not accept any
  command from the user. </li>
</ul>
<p>To terminal the session, focus on frame window and press <code>q</code>. Or focus on the
terminal and press <code>Ctrl+C</code>. </p>
<h2 id="what-is-being-printed">What is being printed?</h2>
<p>See function <code>write_data_line</code> in file <code>Arduino/main.ino</code>. Each line is in csv
format with 13 fields. </p>
<pre class="highlight"><code class="language-c">char msg[100];
sprintf(msg, "%lu,%s,%d,%d,%d,%d,%d,%d,%s,%d,%ld"
        , timestamp, PROTO_CODE, trial_count_
        , puff, tone, led
        , camera, microscope, trial_state_
        , shock_pin_readout, encoder_value_
);</code></pre>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../build_pipeline/" class="btn btn-neutral float-right" title="Build pipeline">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href=".." class="btn btn-neutral" title="Home"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
          <a href="https://github.com/BhallaLab/MouseBehaviour/" class="fa fa-github" style="float: left; color: #fcfcfc"> GitHub</a>
      
      
        <span><a href=".." style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../build_pipeline/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js" defer></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" defer></script>
      <script src="../search/main.js" defer></script>

</body>
</html>
